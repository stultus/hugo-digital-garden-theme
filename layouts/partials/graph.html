<div id="graph-container" style="width: 100%; height: 500px; border: 1px solid var(--code-border-color); border-radius: 4px; margin-bottom: 2rem;"></div>

<script src="//unpkg.com/force-graph"></script>
<script>
  // Use site base URL + index.json to handle subpaths correctly
  fetch('{{ "index.json" | relURL }}')
    .then(res => {
        if (!res.ok) {
            throw new Error('Network response was not ok');
        }
        return res.json();
    })
    .then(data => {
      const nodes = data.map(page => ({ 
        id: page.id, // Use page Title as ID
        url: page.url,
        status: page.status,
        type: page.type,
        val: 1 
      }));
      
      const links = [];
      data.forEach(source => {
        if (source.links) {
          source.links.forEach(target => {
            // Check if target exists in nodes to avoid broken graph links
            if (nodes.find(n => n.id === target)) {
                links.push({ source: source.id, target: target });
            }
          });
        }
      });

      const Graph = ForceGraph()
        (document.getElementById('graph-container'))
        .graphData({ nodes, links })
        .nodeLabel('id')
        .nodeColor(node => {
            if (node.type === 'source') return '#ff4d4d'; // Red for Sources
            if (node.status === 'evergreen') return 'var(--status-evergreen)'; // Green
            if (node.status === 'growing') return 'var(--status-budding)';   // Blue
            return 'var(--status-seeding)'; // Gold
        })
        .onNodeClick(node => {
            window.location.href = node.url;
        });
        
        // Fit to canvas
        Graph.zoomToFit(400);
    })
    .catch(error => {
        console.error('Error fetching graph data:', error);
        document.getElementById('graph-container').innerHTML = '<p class="text-center p-5 text-muted">Could not load graph data. Please try again later.</p>';
    });
</script>
