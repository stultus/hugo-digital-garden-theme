<div id="graph-container"></div>

<script src="//unpkg.com/force-graph"></script>
<script>
  fetch('{{ "index.json" | relURL }}')
    .then(res => res.ok ? res.json() : Promise.reject('Failed to load'))
    .then(data => {
      // Filter out pages with no links and sources
      const connectedPages = data.filter(page => 
        page.links && page.links.length > 0 && page.type !== 'source'
      );
      
      if (connectedPages.length === 0) {
        document.getElementById('graph-container').innerHTML = 
          '<p style="text-align: center; padding: 3rem; color: var(--text-muted);">No connections yet. Start linking notes.</p>';
        return;
      }
      
      const nodes = connectedPages.map(page => ({ 
        id: page.id,
        url: page.url,
        status: page.status || 'seeding',
        val: (page.links || []).length + 1
      }));
      
      const links = [];
      const nodeIds = new Set(nodes.map(n => n.id));
      
      connectedPages.forEach(source => {
        (source.links || []).forEach(target => {
          if (nodeIds.has(target) && source.id !== target) {
            links.push({ source: source.id, target: target });
          }
        });
      });
      
      if (links.length === 0) {
        document.getElementById('graph-container').innerHTML = 
          '<p style="text-align: center; padding: 3rem; color: var(--text-muted);">No connections yet. Start linking notes.</p>';
        return;
      }

      const container = document.getElementById('graph-container');
      const containerWidth = container.offsetWidth;

      const Graph = ForceGraph()
        (container)
        .graphData({ nodes, links })
        .width(containerWidth)
        .height(400)
        .nodeLabel('id')
        .nodeRelSize(4)
        .nodeColor(node => {
          if (node.status === 'evergreen') return '#10b981';
          if (node.status === 'growing') return '#3b82f6';
          return '#f59e0b';
        })
        .linkColor(() => getComputedStyle(document.documentElement).getPropertyValue('--border').trim())
        .linkWidth(1)
        .onNodeClick(node => window.location.href = node.url)
        .onNodeHover(node => {
          container.style.cursor = node ? 'pointer' : 'default';
        });
        
      // Apply d3 forces separately
      Graph.d3Force('charge').strength(-200);
      Graph.d3Force('center').strength(0.5);
        
      // Zoom to fit after a short delay
      setTimeout(() => {
        if (Graph.zoomToFit) {
          Graph.zoomToFit(400, 20);
        }
      }, 100);
    })
    .catch(error => {
      console.error('Graph error:', error);
      document.getElementById('graph-container').innerHTML = 
        '<p style="text-align: center; padding: 3rem; color: var(--text-muted);">Could not load graph.</p>';
    });
</script>
