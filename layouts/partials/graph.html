<div id="graph-container"></div>

<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/force-graph"></script>
<script>
  fetch('{{ "index.json" | relURL }}')
    .then(res => res.ok ? res.json() : Promise.reject('Failed to load'))
    .then(data => {
      // Filter out pages with no links and sources
      const connectedPages = data.filter(page => 
        page.links && page.links.length > 0 && page.type !== 'source'
      );
      
      if (connectedPages.length === 0) {
        document.getElementById('graph-container').innerHTML = 
          '<p style="text-align: center; padding: 3rem; color: var(--text-muted);">No connections yet. Start linking notes.</p>';
        return;
      }
      
      const nodes = connectedPages.map(page => ({ 
        id: page.id,
        url: page.url,
        status: page.status || 'seeding',
        val: (page.links || []).length + 1
      }));
      
      const links = [];
      const nodeIds = new Set(nodes.map(n => n.id));
      
      connectedPages.forEach(source => {
        (source.links || []).forEach(target => {
          if (nodeIds.has(target) && source.id !== target) {
            links.push({ source: source.id, target: target });
          }
        });
      });
      
      if (links.length === 0) {
        document.getElementById('graph-container').innerHTML = 
          '<p style="text-align: center; padding: 3rem; color: var(--text-muted);">No connections yet. Start linking notes.</p>';
        return;
      }

      const container = document.getElementById('graph-container');
      const containerWidth = container.offsetWidth;

      const Graph = ForceGraph()
        (container)
        .graphData({ nodes, links })
        .width(containerWidth)
        .height(500)
        .nodeLabel('id')
        .nodeRelSize(6)
        .nodeColor(node => {
          if (node.status === 'evergreen') return '#10b981';
          if (node.status === 'growing') return '#3b82f6';
          return '#f59e0b';
        })
        .nodeCanvasObject((node, ctx, globalScale) => {
          // Draw node circle
          const size = 6;
          ctx.beginPath();
          ctx.arc(node.x, node.y, size, 0, 2 * Math.PI, false);
          ctx.fillStyle = node.color || (node.status === 'evergreen' ? '#10b981' : node.status === 'growing' ? '#3b82f6' : '#f59e0b');
          ctx.fill();
          
          // Draw label
          const label = node.id;
          const fontSize = 12/globalScale;
          ctx.font = `${fontSize}px IBM Plex Mono, monospace`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          
          // Get text color from CSS variable, fallback to dark/light based on theme
          const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() || 
                           (document.body.classList.contains('dark-theme') ? '#d8dee9' : '#2e3440');
          ctx.fillStyle = textColor;
          ctx.fillText(label, node.x, node.y + size + fontSize);
        })
        .nodePointerAreaPaint((node, color, ctx) => {
          ctx.fillStyle = color;
          const size = 6;
          ctx.fillRect(node.x - size, node.y - size, size * 2, size * 2);
        })
        .linkColor(() => getComputedStyle(document.documentElement).getPropertyValue('--border').trim())
        .linkWidth(1.5)
        .onNodeClick(node => window.location.href = node.url)
        .onNodeHover(node => {
          container.style.cursor = node ? 'pointer' : 'default';
        })
        .cooldownTicks(100)
        .onEngineStop(() => {
          // Zoom to fit all nodes after layout stabilizes
          if (Graph.zoomToFit) {
            Graph.zoomToFit(400, 50);
          }
        });
        
      // Apply d3 forces separately with stronger repulsion for spacing
      Graph.d3Force('charge').strength(-800);
      Graph.d3Force('link').distance(150);
      Graph.d3Force('center').strength(0.2);
      Graph.d3Force('collide', d3.forceCollide(30));
    })
    .catch(error => {
      console.error('Graph error:', error);
      document.getElementById('graph-container').innerHTML = 
        '<p style="text-align: center; padding: 3rem; color: var(--text-muted);">Could not load graph.</p>';
    });
</script>
