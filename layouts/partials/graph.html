<div id="graph-container" style="width: 100%; height: 400px; border: 1px solid var(--border-color, #e5e7eb); border-radius: 8px; margin-bottom: 2rem; background: var(--graph-bg, #fafafa);"></div>

<script src="//unpkg.com/force-graph"></script>
<script>
  fetch('{{ "index.json" | relURL }}')
    .then(res => res.ok ? res.json() : Promise.reject('Failed to load'))
    .then(data => {
      // Filter out pages with no links and sources
      const connectedPages = data.filter(page => 
        page.links && page.links.length > 0 && page.type !== 'source'
      );
      
      if (connectedPages.length === 0) {
        document.getElementById('graph-container').innerHTML = 
          '<p style="text-align: center; padding: 3rem; color: #9ca3af;">No connections yet. Start linking notes with [[wikilinks]].</p>';
        return;
      }
      
      const nodes = connectedPages.map(page => ({ 
        id: page.id,
        url: page.url,
        status: page.status || 'seeding',
        val: (page.links || []).length + 1
      }));
      
      const links = [];
      const nodeIds = new Set(nodes.map(n => n.id));
      
      connectedPages.forEach(source => {
        (source.links || []).forEach(target => {
          if (nodeIds.has(target) && source.id !== target) {
            links.push({ source: source.id, target: target });
          }
        });
      });
      
      if (links.length === 0) {
        document.getElementById('graph-container').innerHTML = 
          '<p style="text-align: center; padding: 3rem; color: #9ca3af;">No connections yet. Start linking notes with [[wikilinks]].</p>';
        return;
      }

      const Graph = ForceGraph()
        (document.getElementById('graph-container'))
        .graphData({ nodes, links })
        .nodeLabel('id')
        .nodeRelSize(4)
        .nodeColor(node => {
          if (node.status === 'evergreen') return '#10b981';
          if (node.status === 'growing') return '#3b82f6';
          return '#f59e0b';
        })
        .linkColor(() => '#d1d5db')
        .linkWidth(1)
        .onNodeClick(node => window.location.href = node.url)
        .onNodeHover(node => {
          document.getElementById('graph-container').style.cursor = node ? 'pointer' : 'default';
        })
        .d3Force('charge').strength(-100);
        
      Graph.zoomToFit(400, 20);
    })
    .catch(error => {
      console.error('Graph error:', error);
      document.getElementById('graph-container').innerHTML = 
        '<p style="text-align: center; padding: 3rem; color: #ef4444;">Could not load graph.</p>';
    });
</script>
