<div style="position: relative;">
  <div id="graph-container" style="background-color: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; min-height: 600px;"></div>
  <div style="position: absolute; bottom: 1rem; right: 1rem; font-size: 0.75rem; color: var(--text-muted); background: var(--bg-primary); padding: 0.5rem 0.75rem; border-radius: 4px; border: 1px solid var(--border); font-family: var(--font-code);">
    ðŸ’¡ Scroll to zoom â€¢ Drag to pan â€¢ Click nodes to navigate
  </div>
</div>

<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/force-graph"></script>
<script>
  fetch('{{ "index.json" | relURL }}')
    .then(res => res.ok ? res.json() : Promise.reject('Failed to load'))
    .then(data => {
      // Filter out pages with no links and sources
      const connectedPages = data.filter(page => 
        page.links && page.links.length > 0 && page.type !== 'source'
      );
      
      if (connectedPages.length === 0) {
        document.getElementById('graph-container').innerHTML = 
          '<p style="text-align: center; padding: 3rem; color: var(--text-muted);">No connections yet. Start linking notes.</p>';
        return;
      }
      
      const nodes = connectedPages.map(page => ({ 
        id: page.id,
        url: page.url,
        status: page.status || 'seeding',
        val: (page.links || []).length + 1
      }));
      
      const links = [];
      const nodeIds = new Set(nodes.map(n => n.id));
      
      connectedPages.forEach(source => {
        (source.links || []).forEach(target => {
          if (nodeIds.has(target) && source.id !== target) {
            links.push({ source: source.id, target: target });
          }
        });
      });
      
      if (links.length === 0) {
        document.getElementById('graph-container').innerHTML = 
          '<p style="text-align: center; padding: 3rem; color: var(--text-muted);">No connections yet. Start linking notes.</p>';
        return;
      }

      const container = document.getElementById('graph-container');
      const containerWidth = container.offsetWidth;

      const Graph = ForceGraph()
        (container)
        .graphData({ nodes, links })
        .width(containerWidth)
        .height(600)
        .nodeLabel('id')
        .nodeRelSize(10)
        .nodeColor(node => {
          if (node.status === 'evergreen') return '#10b981';
          if (node.status === 'growing') return '#3b82f6';
          return '#f59e0b';
        })
        .nodeCanvasObject((node, ctx, globalScale) => {
          // Draw node circle - much larger and always visible
          const size = 12;
          ctx.beginPath();
          ctx.arc(node.x, node.y, size, 0, 2 * Math.PI, false);
          ctx.fillStyle = node.color || (node.status === 'evergreen' ? '#10b981' : node.status === 'growing' ? '#3b82f6' : '#f59e0b');
          ctx.fill();
          
          // Add a subtle border to make nodes stand out
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
          ctx.lineWidth = 2;
          ctx.stroke();
          
          // Draw label - larger font and better positioning
          const label = node.id;
          const fontSize = 13;
          ctx.font = `${fontSize}px IBM Plex Mono, monospace`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          
          // Get text color - ensure it's visible in both modes
          const isDark = document.body.classList.contains('dark-theme');
          const textColor = isDark ? '#d8dee9' : '#2e3440';
          ctx.fillStyle = textColor;
          
          // Position label below node with more spacing
          ctx.fillText(label, node.x, node.y + size + 10);
        })
        .nodePointerAreaPaint((node, color, ctx) => {
          ctx.fillStyle = color;
          const size = 15;
          ctx.fillRect(node.x - size, node.y - size, size * 2, size * 2);
        })
        .linkColor(() => {
          const isDark = document.body.classList.contains('dark-theme');
          return isDark ? '#4a4a4a' : '#d0d0d0';
        })
        .linkWidth(1.5)
        .onNodeClick(node => window.location.href = node.url)
        .onNodeHover(node => {
          container.style.cursor = node ? 'pointer' : 'default';
        })
        .cooldownTicks(100)
        .zoom(2.5)  // Start with a good zoom level
        .enableNodeDrag(true)  // Allow dragging nodes like Obsidian
        .enableZoomInteraction(true)  // Enable zoom with mouse wheel
        .enablePanInteraction(true);  // Enable panning
        
      // Apply d3 forces with very strong repulsion for better spacing
      Graph.d3Force('charge').strength(-2000);
      Graph.d3Force('link').distance(120);
      Graph.d3Force('center').strength(0.05);
      Graph.d3Force('collide', d3.forceCollide(80));
    })
    .catch(error => {
      console.error('Graph error:', error);
      document.getElementById('graph-container').innerHTML = 
        '<p style="text-align: center; padding: 3rem; color: var(--text-muted);">Could not load graph.</p>';
    });
</script>
