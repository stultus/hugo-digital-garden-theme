{{ define "main" }}
<div class="container">
    
    <!-- Back Link -->
    <a href="{{ "/" | relURL }}" class="back-link">â† Notes</a>
    
    <!-- Title -->
    <h1>{{ .Title }}</h1>
    
    <!-- Metadata -->
    <div class="metadata">
        {{ with .Date }}Created {{ .Format "2006-01-02" }}{{ end }}
        {{ with .Lastmod }}Â· Updated {{ .Format "2006-01-02" }}{{ end }}
        {{ with .Params.status }}
        Â· <span class="status status-{{ . }}">
            {{ if eq . "evergreen" }}ğŸŒ³{{ else if eq . "growing" }}ğŸŒ¿{{ else }}ğŸŒ±{{ end }}
            {{ . }}
        </span>
        {{ end }}
        {{ with .Params.tags }}
        <div style="margin-top: 0.5rem;">
            {{ range . }}
            <a href="{{ printf "tags/%s" (urlize .) | relURL }}" class="tag">{{ . }}</a>
            {{ end }}
        </div>
        {{ end }}
    </div>

    <!-- Main Content -->
    <div class="content">
        {{ .Content | safeHTML }}
    </div>

    <!-- Backlinks Section -->
    {{ $currentPage := . }}
    {{ $currentPermalink := .Permalink }}
    {{ $currentRelPermalink := .RelPermalink }}
    {{ $currentFilePath := .File.Path }}
    {{ $backlinks := slice }}
    
    {{ range .Site.RegularPages }}
        {{ $content := .RawContent }}
        {{ if and (ne .Permalink $currentPermalink)
            (or
                (in $content (printf "ref \"%s\"" $currentFilePath))
                (in $content $currentPermalink)
                (in $content $currentRelPermalink)
                (in $content (printf "[%s]" $currentPage.Title))
            )
        }}
            {{ $backlinks = $backlinks | append . }}
        {{ end }}
    {{ end }}
    
    {{ if gt (len $backlinks) 0 }}
        <div class="backlinks">
            <h3>Linked References</h3>
            <ul>
                {{ range $backlinks }}
                    <li>
                        <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                        {{ if .Summary }}
                        <div class="backlinks-summary">{{ .Summary | truncate 120 }}</div>
                        {{ end }}
                    </li>
                {{ end }}
            </ul>
        </div>
    {{ end }}
</div>

{{ end }}
