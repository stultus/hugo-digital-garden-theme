{{- $dest := .Destination -}}
{{- $text := .Text -}}
{{- $title := .Title -}}

{{- /* Check if it's an external link, anchor, or absolute path starting with /notes/ */ -}}
{{- if or (hasPrefix $dest "http") (hasPrefix $dest "https") (hasPrefix $dest "mailto:") (hasPrefix $dest "#") (hasPrefix $dest "/notes/") -}}
  {{- /* Pass through as-is */ -}}
  <a href="{{ $dest | safeURL }}" {{ with $title }}title="{{ . }}"{{ end }}{{ if hasPrefix $dest "http" }} target="_blank" rel="noopener"{{ end }}>{{ $text }}</a>
{{- else -}}
  {{- /* Internal link - try to resolve it */ -}}
  {{- $page := false -}}
  
  {{- /* Clean the destination */ -}}
  {{- $cleanDest := $dest -}}
  {{- $cleanDest = strings.TrimSuffix $cleanDest "/" -}}
  {{- $cleanDest = strings.TrimSuffix $cleanDest ".md" -}}
  {{- $cleanDest = strings.TrimPrefix $cleanDest "/" -}}
  
  {{- /* Try various GetPage strategies */ -}}
  {{- $page = site.GetPage (printf "%s.md" $cleanDest) -}}
  {{- if not $page -}}
    {{- $page = site.GetPage $cleanDest -}}
  {{- end -}}
  {{- if not $page -}}
    {{- $page = site.GetPage (printf "sources/%s.md" $cleanDest) -}}
  {{- end -}}
  {{- if not $page -}}
    {{- $page = site.GetPage (printf "sources/%s" $cleanDest) -}}
  {{- end -}}
  
  {{- /* Title Match for WikiLinks - use the link text as title */ -}}
  {{- if not $page -}}
    {{- range site.RegularPages -}}
        {{- if or (eq .Title $text) (eq (lower .Title) (lower $text)) (eq .Title $cleanDest) (eq (lower .Title) (lower $cleanDest)) -}}
            {{- $page = . -}}
            {{- break -}}
        {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{- if $page -}}
    <a href="{{ $page.RelPermalink }}" {{ with $title }}title="{{ . }}"{{ end }}>{{ $text }}</a>
  {{- else -}}
    <span class="broken-link" style="color: #ef4444;">{{ $text }}</span>
  {{- end -}}
{{- end -}}
