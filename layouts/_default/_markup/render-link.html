{{- $dest := .Destination -}}
{{- $text := .Text -}}
{{- $title := .Title -}}

{{- /* Check if it's a WikiLink (internal link not starting with http/https/mailto) */ -}}
{{- if and (not (hasPrefix $dest "http")) (not (hasPrefix $dest "mailto:")) (not (hasPrefix $dest "#")) (not (hasPrefix $dest "/")) -}}
  {{- /* Try to find the page by filename or title */ -}}
  {{- $page := .Page.GetPage $dest -}}
  {{- if $page -}}
    <a href="{{ $page.RelPermalink }}" {{ with $title }}title="{{ . }}"{{ end }}>{{ $text }}</a>
  {{- else -}}
    {{- /* Fallback: Try looking in the garden section explicitly if not found */ -}}
    {{- $gardenPage := .Page.GetPage (printf "garden/%s" $dest) -}}
    {{- if $gardenPage -}}
        <a href="{{ $gardenPage.RelPermalink }}" {{ with $title }}title="{{ . }}"{{ end }}>{{ $text }}</a>
    {{- else -}}
        {{- /* If still not found, mark as broken */ -}}
        <a href="{{ $dest | safeURL }}" class="broken-link" {{ with $title }}title="{{ . }}"{{ end }}>{{ $text }}</a>
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{- /* Standard link */ -}}
  <a href="{{ $dest | safeURL }}" {{ with $title }}title="{{ . }}"{{ end }}{{ if hasPrefix $dest "http" }} target="_blank" rel="noopener"{{ end }}>{{ $text }}</a>
{{- end -}}
