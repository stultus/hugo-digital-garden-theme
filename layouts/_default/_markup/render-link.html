{{- $dest := .Destination -}}
{{- $text := .Text -}}
{{- $title := .Title -}}

{{- /* Check if it's a WikiLink (internal link not starting with http/https/mailto) */ -}}
{{- if and (not (hasPrefix $dest "http")) (not (hasPrefix $dest "mailto:")) (not (hasPrefix $dest "#")) (not (hasPrefix $dest "/")) -}}
  
  {{- /* Handle "[[Text]]" format which Hugo might pass as destination "Text" */ -}}
  {{- $page := false -}}

  {{- /* 1. Exact Path Match (fastest) */ -}}
  {{- $page = .Page.GetPage $dest -}}
  
  {{- /* 2. Root Content Match (e.g. "story.md" or just "story") */ -}}
  {{- if not $page -}}
    {{- $page = site.GetPage $dest -}}
  {{- end -}}

  {{- /* 3. Sources Folder Match */ -}}
  {{- if not $page -}}
    {{- $page = site.GetPage (printf "sources/%s" $dest) -}}
  {{- end -}}

  {{- /* 4. Title Match (The Silver Bullet for WikiLinks) */ -}}
  {{- if not $page -}}
    {{- range where site.RegularPages "Title" $dest -}}
        {{- $page = . -}}
    {{- end -}}
  {{- end -}}

  {{- /* 5. Case-Insensitive Title Match (Last Resort) */ -}}
  {{- if not $page -}}
    {{- range site.RegularPages -}}
        {{- if eq (lower .Title) (lower $dest) -}}
            {{- $page = . -}}
            {{- break -}}
        {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if $page -}}
    <a href="{{ $page.RelPermalink }}" {{ with $title }}title="{{ . }}"{{ end }}>{{ $text }}</a>
  {{- else -}}
    {{- /* If page not found, mark as broken */ -}}
    <a href="#" class="broken-link text-danger" {{ with $title }}title="{{ . }}"{{ end }} style="color: red; text-decoration: line-through;">{{ $text }}</a>
  {{- end -}}
{{- else -}}
  {{- /* Standard link */ -}}
  <a href="{{ $dest | safeURL }}" {{ with $title }}title="{{ . }}"{{ end }}{{ if hasPrefix $dest "http" }} target="_blank" rel="noopener"{{ end }}>{{ $text }}</a>
{{- end -}}
