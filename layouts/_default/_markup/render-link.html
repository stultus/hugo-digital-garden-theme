{{- $dest := .Destination -}}
{{- $text := .Text -}}
{{- $title := .Title -}}

{{- /* Check if it's an external link, anchor, or absolute path starting with /notes/ */ -}}
{{- if or (hasPrefix $dest "http") (hasPrefix $dest "https") (hasPrefix $dest "mailto:") (hasPrefix $dest "#") (hasPrefix $dest "/notes/") -}}
  {{- /* Pass through as-is */ -}}
  <a href="{{ $dest | safeURL }}" {{ with $title }}title="{{ . }}"{{ end }}{{ if hasPrefix $dest "http" }} target="_blank" rel="noopener"{{ end }}>{{ $text }}</a>
{{- else -}}
  {{- /* Internal link - try to resolve it */ -}}
  {{- $page := false -}}
  
  {{- /* Clean the destination */ -}}
  {{- $cleanDest := $dest -}}
  {{- $cleanDest = strings.TrimSuffix $cleanDest "/" -}}
  {{- $cleanDest = strings.TrimSuffix $cleanDest ".md" -}}
  {{- $cleanDest = strings.TrimPrefix $cleanDest "/" -}}
  
  {{- /* Title Match - use the link text to find the page */ -}}
  {{- range site.RegularPages -}}
      {{- if eq .Title $text -}}
          {{- $page = . -}}
          {{- break -}}
      {{- end -}}
  {{- end -}}
  
  {{- if $page -}}
    <a href="{{ $page.RelPermalink }}" {{ with $title }}title="{{ . }}"{{ end }}>{{ $text }}</a>
  {{- else -}}
    <span class="broken-link" style="color: #ef4444; text-decoration: line-through;">{{ $text }}</span>
  {{- end -}}
{{- end -}}
